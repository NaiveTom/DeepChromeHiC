

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>train.py &mdash; DeepChromeHiC 2.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="test.py" href="test.py.html" />
    <link rel="prev" title="data_preprocessing.py" href="data_preprocessing.py.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> DeepChromeHiC
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Catalog:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">DeepChromeHiC Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="supercomputer.html">Run on a Supercomputer</a></li>
<li class="toctree-l1"><a class="reference internal" href="DeepChromeHiC.py.html">DeepChromeHiC.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="datastructure.html">Data Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_preprocessing.py.html">data_preprocessing.py</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">train.py</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#train-cnn-dense-resnet">train_cnn_dense_resnet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#function-prototype">Function prototype</a></li>
<li class="toctree-l3"><a class="reference internal" href="#imagedatagenerator">ImageDataGenerator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#earlystopping">EarlyStopping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plotprogress">PlotProgress</a></li>
<li class="toctree-l3"><a class="reference internal" href="#save-weights">Save Weights</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#train-cnn-separate">train_cnn_separate</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Function prototype</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">ImageDataGenerator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">EarlyStopping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Save Weights</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#train-embedding">train_embedding</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">Function prototype</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">EarlyStopping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">PlotProgress</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Save Weights</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="test.py.html">test.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="model.py.html">model.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Log and Processing Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="reStructuredText.html">reStructuredText Writing Help</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DeepChromeHiC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>train.py</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/train.py.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="train-py">
<h1>train.py<a class="headerlink" href="#train-py" title="Permalink to this headline">¶</a></h1>
<p>In order to adapt to different models, <code class="docutils literal notranslate"><span class="pre">train.py</span></code> is divided into three parts to perform three different model training tasks. train.py is friendly to supercomputer logs. It turns off the display of the progress bar to avoid flooding the screen and log system. At the same time, the picture will not be displayed and will be saved directly to the corresponding location.</p>
<img alt="_images/div.png" src="_images/div.png" />
<div class="section" id="train-cnn-dense-resnet">
<h2>train_cnn_dense_resnet<a class="headerlink" href="#train-cnn-dense-resnet" title="Permalink to this headline">¶</a></h2>
<div class="section" id="function-prototype">
<h3>Function prototype<a class="headerlink" href="#function-prototype" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">train_cnn_dense_resnet</span><span class="p">(</span><span class="n">gen_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
</pre></div>
</div>
<p>This function is called by <code class="docutils literal notranslate"><span class="pre">DeepChromeHiC.py</span></code> . There are two inputs: the name of the gene to be trained <code class="docutils literal notranslate"><span class="pre">gen_name</span></code> and the name of the selected model <code class="docutils literal notranslate"><span class="pre">model_name</span></code></p>
<p>This function has no return value.</p>
<p>This function can train the following models:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_cnn_one_branch</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_embedding_dense</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_dense</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_resnet18</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_resnet34</span></code></p></li>
</ol>
<p>The model used by this function does <code class="docutils literal notranslate"><span class="pre">not</span></code> require <code class="docutils literal notranslate"><span class="pre">dna2vec</span> <span class="pre">embedding</span></code>, and the data is <code class="docutils literal notranslate"><span class="pre">merged</span> <span class="pre">before</span> <span class="pre">entering</span> <span class="pre">the</span> <span class="pre">model</span></code>.</p>
</div>
<div class="section" id="imagedatagenerator">
<h3>ImageDataGenerator<a class="headerlink" href="#imagedatagenerator" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the problem of storage space consumption, this model uses <code class="docutils literal notranslate"><span class="pre">png</span></code> images as input, and png uses Huffman coding compression, which greatly reduces the volume of data. Because the CPU speed is faster than the disk, it will not consume too much time to decode after being compressed into png format, and it is faster than reading the original data under the actual test.</p>
<p>ImageDataGenerator has completed data shuffling.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>

    <span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.11</span><span class="p">)</span> <span class="c1"># set validation split</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">train_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/png_train/&#39;</span><span class="p">,</span>
                                                    <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20002</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                                    <span class="n">color_mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span><span class="p">,</span>
                                                    <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                                                    <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span>  <span class="c1"># set as training data</span>
                                                    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># shuffle</span>
                                                    <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
                                                    <span class="p">)</span>
<span class="n">val_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/png_train/&#39;</span><span class="p">,</span> <span class="c1"># same directory as training data</span>
                                                  <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20002</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                                  <span class="n">color_mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span><span class="p">,</span>
                                                  <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                  <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                                                  <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="c1"># set as validation data</span>
                                                  <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># shuffle</span>
                                                  <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
                                                  <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="earlystopping">
<h3>EarlyStopping<a class="headerlink" href="#earlystopping" title="Permalink to this headline">¶</a></h3>
<img alt="_images/earlystopping.png" src="_images/earlystopping.png" />
<p>In order to avoid <code class="docutils literal notranslate"><span class="pre">over-fitting</span></code> problems, EarlyStopping is adopted, which can end the training process before over-fitting occurs.</p>
<p>The tolerance is set to <code class="docutils literal notranslate"><span class="pre">10</span></code> epoches, and the <code class="docutils literal notranslate"><span class="pre">best</span> <span class="pre">weights</span></code> will be saved. This is the optimal parameter after testing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> <span class="n">patience</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="plotprogress">
<h3>PlotProgress<a class="headerlink" href="#plotprogress" title="Permalink to this headline">¶</a></h3>
<img alt="_images/loss.png" src="_images/loss.png" />
<img alt="_images/acc.png" src="_images/acc.png" />
<p>In order to show the situation during the training process more clearly, I wrote a function to show the loss and accuracy during the training process. They include training set loss, validation set loss, training set accuracy, and validation set accuracy.</p>
<p>The display is shown in the figure above, and the source code is below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Call Class</span>
<span class="n">plot_progress</span> <span class="o">=</span> <span class="n">PlotProgress</span><span class="p">(</span><span class="n">entity</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># Class Prototype</span>
<span class="k">class</span> <span class="nc">PlotProgress</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">]):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>

<span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_accs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># loss</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="c1"># acc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span> <span class="c1"># clear output</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;result/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;/loss.png&#39;</span><span class="p">)</span>
    <span class="c1"># plt.pause(0.01)</span>
    <span class="c1"># plt.show() # Supercomputers are completely command lines and cannot display pictures.</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># clear output</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_accs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;result/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;/acc.png&#39;</span><span class="p">)</span>
    <span class="c1"># plt.pause(0.01)</span>
    <span class="c1"># plt.show() # Supercomputers are completely command lines and cannot display pictures.</span>
</pre></div>
</div>
</div>
<div class="section" id="save-weights">
<h3>Save Weights<a class="headerlink" href="#save-weights" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the amount of saved data, a scheme of saving <code class="docutils literal notranslate"><span class="pre">weights</span></code> is adopted. The trained model will save the weight to the <code class="docutils literal notranslate"><span class="pre">h5_weight</span></code> file directory. When testing the model later, the system will <code class="docutils literal notranslate"><span class="pre">automatically</span></code> identify the save path.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">clf</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;h5_weights/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
<span class="c1"># Print it out for easy inspection</span>
<span class="n">fancy_print</span><span class="p">(</span><span class="s1">&#39;save_weights&#39;</span><span class="p">,</span> <span class="s1">&#39;h5_weights/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/div.png" src="_images/div.png" />
</div>
</div>
<div class="section" id="train-cnn-separate">
<h2>train_cnn_separate<a class="headerlink" href="#train-cnn-separate" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Function prototype<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">train_cnn_separate</span><span class="p">(</span><span class="n">gen_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
</pre></div>
</div>
<p>This function is called by <code class="docutils literal notranslate"><span class="pre">DeepChromeHiC.py</span></code> . There are two inputs: the name of the gene to be trained <code class="docutils literal notranslate"><span class="pre">gen_name</span></code> and the name of the selected model <code class="docutils literal notranslate"><span class="pre">model_name</span></code></p>
<p>This function has no return value.</p>
<p>This function can train the following models:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_cnn_two_branch</span></code></p></li>
</ol>
<p>The model used by this function does <code class="docutils literal notranslate"><span class="pre">not</span></code> require <code class="docutils literal notranslate"><span class="pre">dna2vec</span> <span class="pre">embedding</span></code>, and the data is <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">merged</span> <span class="pre">before</span> <span class="pre">entering</span> <span class="pre">the</span> <span class="pre">model</span></code>.</p>
</div>
<div class="section" id="id2">
<h3>ImageDataGenerator<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the problem of storage space consumption, this model uses <code class="docutils literal notranslate"><span class="pre">png</span></code> images as input, and png uses Huffman coding compression, which greatly reduces the volume of data. Because the CPU speed is faster than the disk, it will not consume too much time to decode after being compressed into png format, and it is faster than reading the original data under the actual test.</p>
<p>ImageDataGenerator has completed data shuffling.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>

<span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.11</span><span class="p">)</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>

<span class="k">def</span> <span class="nf">generator_two_train</span><span class="p">():</span>
    <span class="n">train_generator1</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/train_en/&#39;</span><span class="p">,</span> <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10001</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                                         <span class="n">color_mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span><span class="p">,</span>
                                                         <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                         <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                                                         <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="c1"># set as training data</span>
                                                         <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                         <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="c1"># Shuffle in the same way</span>
    <span class="n">train_generator2</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/train_pr/&#39;</span><span class="p">,</span> <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10001</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                                         <span class="n">color_mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span><span class="p">,</span>
                                                         <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                         <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                                                         <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="c1"># set as training data</span>
                                                         <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                         <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="c1"># Shuffle in the same way</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">train_generator1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">train_generator2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">yield</span> <span class="p">[</span><span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">out1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Return the combination of two and the result</span>

<span class="k">def</span> <span class="nf">generator_two_val</span><span class="p">():</span>
    <span class="n">val_generator1</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/train_en/&#39;</span><span class="p">,</span> <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10001</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                                       <span class="n">color_mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span><span class="p">,</span>
                                                       <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                       <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                                                       <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="c1"># set as validation data</span>
                                                       <span class="n">shuffle</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="c1"># Shuffle in the same way</span>
    <span class="n">val_generator2</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/train_pr/&#39;</span><span class="p">,</span> <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10001</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                                       <span class="n">color_mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span><span class="p">,</span>
                                                       <span class="n">class_mode</span> <span class="o">=</span> <span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
                                                       <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                                                       <span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="c1"># set as validation data</span>
                                                       <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                                       <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="c1"># Shuffle in the same way</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">val_generator1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">val_generator2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">yield</span> <span class="p">[</span><span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">out1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Return the combination of two and the result</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>EarlyStopping<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<img alt="_images/earlystopping.png" src="_images/earlystopping.png" />
<p>In order to avoid <code class="docutils literal notranslate"><span class="pre">over-fitting</span></code> problems, EarlyStopping is adopted, which can end the training process before over-fitting occurs.</p>
<p>The tolerance is set to <code class="docutils literal notranslate"><span class="pre">10</span></code> epoches, and the <code class="docutils literal notranslate"><span class="pre">best</span> <span class="pre">weights</span></code> will be saved. This is the optimal parameter after testing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> <span class="n">patience</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Save Weights<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the amount of saved data, a scheme of saving <code class="docutils literal notranslate"><span class="pre">weights</span></code> is adopted. The trained model will save the weight to the <code class="docutils literal notranslate"><span class="pre">h5_weight</span></code> file directory. When testing the model later, the system will <code class="docutils literal notranslate"><span class="pre">automatically</span></code> identify the save path.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">clf</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;h5_weights/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
<span class="c1"># Print it out for easy inspection</span>
<span class="n">fancy_print</span><span class="p">(</span><span class="s1">&#39;save_weights&#39;</span><span class="p">,</span> <span class="s1">&#39;h5_weights/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/div.png" src="_images/div.png" />
</div>
</div>
<div class="section" id="train-embedding">
<h2>train_embedding<a class="headerlink" href="#train-embedding" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>Function prototype<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">train_embedding</span><span class="p">(</span><span class="n">gen_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
</pre></div>
</div>
<p>This function is called by <code class="docutils literal notranslate"><span class="pre">DeepChromeHiC.py</span></code> . There are two inputs: the name of the gene to be trained <code class="docutils literal notranslate"><span class="pre">gen_name</span></code> and the name of the selected model <code class="docutils literal notranslate"><span class="pre">model_name</span></code></p>
<p>This function has no return value.</p>
<p>This function can train the following models:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_cnn_one_branch</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_cnn_two_branch</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embedding_dense</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_embedding_cnn_one_branch</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onehot_embedding_cnn_two_branch</span></code></p></li>
</ol>
<p>The model used by this function require <code class="docutils literal notranslate"><span class="pre">dna2vec</span> <span class="pre">embedding</span></code>.</p>
</div>
<div class="section" id="id6">
<h3>EarlyStopping<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<img alt="_images/earlystopping.png" src="_images/earlystopping.png" />
<p>In order to avoid <code class="docutils literal notranslate"><span class="pre">over-fitting</span></code> problems, EarlyStopping is adopted, which can end the training process before over-fitting occurs.</p>
<p>The tolerance is set to <code class="docutils literal notranslate"><span class="pre">20</span></code> epoches, and the <code class="docutils literal notranslate"><span class="pre">best</span> <span class="pre">weights</span></code> will be saved. This is the optimal parameter after testing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> <span class="n">patience</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">restore_best_weights</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>PlotProgress<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<img alt="_images/loss.png" src="_images/loss.png" />
<img alt="_images/acc.png" src="_images/acc.png" />
<p>In order to show the situation during the training process more clearly, I wrote a function to show the loss and accuracy during the training process. They include training set loss, validation set loss, training set accuracy, and validation set accuracy.</p>
<p>The display is shown in the figure above, and the source code is below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Call Class</span>
<span class="n">plot_progress</span> <span class="o">=</span> <span class="n">PlotProgress</span><span class="p">(</span><span class="n">entity</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># Class Prototype</span>
<span class="k">class</span> <span class="nc">PlotProgress</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">]):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>

<span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_accs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># loss</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="c1"># acc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span> <span class="c1"># clear output</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;result/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;/loss.png&#39;</span><span class="p">)</span>
    <span class="c1"># plt.pause(0.01)</span>
    <span class="c1"># plt.show() # Supercomputers are completely command lines and cannot display pictures.</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># clear output</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_accs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;result/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;/acc.png&#39;</span><span class="p">)</span>
    <span class="c1"># plt.pause(0.01)</span>
    <span class="c1"># plt.show() # Supercomputers are completely command lines and cannot display pictures.</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>Save Weights<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the amount of saved data, a scheme of saving <code class="docutils literal notranslate"><span class="pre">weights</span></code> is adopted. The trained model will save the weight to the <code class="docutils literal notranslate"><span class="pre">h5_weight</span></code> file directory. When testing the model later, the system will <code class="docutils literal notranslate"><span class="pre">automatically</span></code> identify the save path.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">clf</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;h5_weights/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
<span class="c1"># Print it out for easy inspection</span>
<span class="n">fancy_print</span><span class="p">(</span><span class="s1">&#39;save_weights&#39;</span><span class="p">,</span> <span class="s1">&#39;h5_weights/&#39;</span><span class="o">+</span><span class="n">gen_name</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/div.png" src="_images/div.png" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="test.py.html" class="btn btn-neutral float-right" title="test.py" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="data_preprocessing.py.html" class="btn btn-neutral float-left" title="data_preprocessing.py" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, bizi.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>